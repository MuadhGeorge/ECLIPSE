name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Build Web Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Emscripten
        run: |
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest

      - name: Build Web Target
        run: |
          source emsdk/emsdk_env.sh
          emcmake cmake -B build-web -DCMAKE_BUILD_TYPE=Release
          cmake --build build-web --config Release

      - name: Prepare Distribution
        run: |
          mkdir -p dist
          
          # Copy HTML as index.html
          cp build-web/eclipse_game_web.html dist/index.html
          
          # Copy JS and WASM files
          cp build-web/eclipse_game_web.js dist/
          cp build-web/eclipse_game_web.wasm dist/
          
          # Copy data file if it exists
          if [ -f build-web/eclipse_game_web.data ]; then
            cp build-web/eclipse_game_web.data dist/
          fi
          
          # Prevent Jekyll processing
          touch dist/.nojekyll
          
          # Fix paths for GitHub Pages - inject base path handling
          cat > dist/fix-paths.js << 'EOF'
// Fix asset paths for GitHub Pages (repo is served under /ECLIPSE/)
(function() {
  // Wait for Module to be defined by Emscripten
  var checkModule = setInterval(function() {
    if (typeof Module !== 'undefined') {
      clearInterval(checkModule);
      
      // Set the correct paths for WebAssembly and data files
      var basePath = window.location.pathname.replace(/\/[^\/]*$/, '/');
      if (!basePath.endsWith('/')) basePath += '/';
      
      // Override locateFile to use the correct base path
      var originalLocateFile = Module.locateFile;
      Module.locateFile = function(path) {
        if (originalLocateFile) {
          return originalLocateFile(path);
        }
        // For GitHub Pages, ensure we use relative paths correctly
        if (path.indexOf('://') === -1) {
          return basePath + path;
        }
        return path;
      };
    }
  }, 10);
})();
EOF
          
          # Inject the path fix script into index.html (before the main JS)
          sed -i '/<script async type="text\/javascript" src="eclipse_game_web.js"><\/script>/i \    <script src="fix-paths.js"><\/script>' dist/index.html
          
          # Verify contents
          echo "Contents of dist/:"
          ls -la dist/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./dist

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
